#include "ctr9/gfx.h"

#include <string.h>

// TODO: Remap to known addresses.
#define FB_TOP_LEFT1 0x20184E60
#define FB_TOP_LEFT2 0x201CB370
#define FB_TOP_RIGHT1 0x20282160
#define FB_TOP_RIGHT2 0x202C8670
#define FB_TOP_WIDTH 400
#define FB_TOP_HEIGHT 240
#define FB_TOP_SIZE	(FB_TOP_WIDTH * FB_TOP_HEIGHT * 3)

#define FB_BOT_1 0x202118E0
#define FB_BOT_2 0x20249CF0
#define FB_BOT_WIDTH 320
#define FB_BOT_HEIGHT 240
#define FB_BOT_SIZE (FB_BOT_WIDTH * FB_BOT_HEIGHT * 3)

static unsigned char asciiData[128][8] = {
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x3E, 0x41, 0x55, 0x41, 0x55, 0x49, 0x3E},
        {0x00, 0x3E, 0x7F, 0x6B, 0x7F, 0x6B, 0x77, 0x3E},
        {0x00, 0x22, 0x77, 0x7F, 0x7F, 0x3E, 0x1C, 0x08},
        {0x00, 0x08, 0x1C, 0x3E, 0x7F, 0x3E, 0x1C, 0x08},
        {0x00, 0x08, 0x1C, 0x2A, 0x7F, 0x2A, 0x08, 0x1C},
        {0x00, 0x08, 0x1C, 0x3E, 0x7F, 0x3E, 0x08, 0x1C},
        {0x00, 0x00, 0x1C, 0x3E, 0x3E, 0x3E, 0x1C, 0x00},
        {0xFF, 0xFF, 0xE3, 0xC1, 0xC1, 0xC1, 0xE3, 0xFF},
        {0x00, 0x00, 0x1C, 0x22, 0x22, 0x22, 0x1C, 0x00},
        {0xFF, 0xFF, 0xE3, 0xDD, 0xDD, 0xDD, 0xE3, 0xFF},
        {0x00, 0x0F, 0x03, 0x05, 0x39, 0x48, 0x48, 0x30},
        {0x00, 0x08, 0x3E, 0x08, 0x1C, 0x22, 0x22, 0x1C},
        {0x00, 0x18, 0x14, 0x10, 0x10, 0x30, 0x70, 0x60},
        {0x00, 0x0F, 0x19, 0x11, 0x13, 0x37, 0x76, 0x60},
        {0x00, 0x08, 0x2A, 0x1C, 0x77, 0x1C, 0x2A, 0x08},
        {0x00, 0x60, 0x78, 0x7E, 0x7F, 0x7E, 0x78, 0x60},
        {0x00, 0x03, 0x0F, 0x3F, 0x7F, 0x3F, 0x0F, 0x03},
        {0x00, 0x08, 0x1C, 0x2A, 0x08, 0x2A, 0x1C, 0x08},
        {0x00, 0x66, 0x66, 0x66, 0x66, 0x00, 0x66, 0x66},
        {0x00, 0x3F, 0x65, 0x65, 0x3D, 0x05, 0x05, 0x05},
        {0x00, 0x0C, 0x32, 0x48, 0x24, 0x12, 0x4C, 0x30},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F},
        {0x00, 0x08, 0x1C, 0x2A, 0x08, 0x2A, 0x1C, 0x3E},
        {0x00, 0x08, 0x1C, 0x3E, 0x7F, 0x1C, 0x1C, 0x1C},
        {0x00, 0x1C, 0x1C, 0x1C, 0x7F, 0x3E, 0x1C, 0x08},
        {0x00, 0x08, 0x0C, 0x7E, 0x7F, 0x7E, 0x0C, 0x08},
        {0x00, 0x08, 0x18, 0x3F, 0x7F, 0x3F, 0x18, 0x08},
        {0x00, 0x00, 0x00, 0x70, 0x70, 0x70, 0x7F, 0x7F},
        {0x00, 0x00, 0x14, 0x22, 0x7F, 0x22, 0x14, 0x00},
        {0x00, 0x08, 0x1C, 0x1C, 0x3E, 0x3E, 0x7F, 0x7F},
        {0x00, 0x7F, 0x7F, 0x3E, 0x3E, 0x1C, 0x1C, 0x08},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18},
        {0x00, 0x36, 0x36, 0x14, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36},
        {0x00, 0x08, 0x1E, 0x20, 0x1C, 0x02, 0x3C, 0x08},
        {0x00, 0x60, 0x66, 0x0C, 0x18, 0x30, 0x66, 0x06},
        {0x00, 0x3C, 0x66, 0x3C, 0x28, 0x65, 0x66, 0x3F},
        {0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00},
        {0x00, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06},
        {0x00, 0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60},
        {0x00, 0x00, 0x36, 0x1C, 0x7F, 0x1C, 0x36, 0x00},
        {0x00, 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00},
        {0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x60},
        {0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60},
        {0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00},
        {0x00, 0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C},
        {0x00, 0x18, 0x18, 0x38, 0x18, 0x18, 0x18, 0x7E},
        {0x00, 0x3C, 0x66, 0x06, 0x0C, 0x30, 0x60, 0x7E},
        {0x00, 0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C},
        {0x00, 0x0C, 0x1C, 0x2C, 0x4C, 0x7E, 0x0C, 0x0C},
        {0x00, 0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C},
        {0x00, 0x3C, 0x66, 0x60, 0x7C, 0x66, 0x66, 0x3C},
        {0x00, 0x7E, 0x66, 0x0C, 0x0C, 0x18, 0x18, 0x18},
        {0x00, 0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C},
        {0x00, 0x3C, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C},
        {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00},
        {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x30},
        {0x00, 0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06},
        {0x00, 0x00, 0x00, 0x3C, 0x00, 0x3C, 0x00, 0x00},
        {0x00, 0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60},
        {0x00, 0x3C, 0x66, 0x06, 0x1C, 0x18, 0x00, 0x18},
        {0x00, 0x38, 0x44, 0x5C, 0x58, 0x42, 0x3C, 0x00},
        {0x00, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66},
        {0x00, 0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C},
        {0x00, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C},
        {0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7C},
        {0x00, 0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x7E},
        {0x00, 0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60},
        {0x00, 0x3C, 0x66, 0x60, 0x60, 0x6E, 0x66, 0x3C},
        {0x00, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66},
        {0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C},
        {0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x6C, 0x6C, 0x38},
        {0x00, 0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66},
        {0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E},
        {0x00, 0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63},
        {0x00, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x63, 0x63},
        {0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C},
        {0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60},
        {0x00, 0x3C, 0x66, 0x66, 0x66, 0x6E, 0x3C, 0x06},
        {0x00, 0x7C, 0x66, 0x66, 0x7C, 0x78, 0x6C, 0x66},
        {0x00, 0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C},
        {0x00, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x18, 0x18},
        {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3E},
        {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18},
        {0x00, 0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63},
        {0x00, 0x63, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x63},
        {0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18},
        {0x00, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E},
        {0x00, 0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E},
        {0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00},
        {0x00, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x78},
        {0x00, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F},
        {0x00, 0x0C, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E},
        {0x00, 0x60, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x7C},
        {0x00, 0x00, 0x00, 0x3C, 0x66, 0x60, 0x66, 0x3C},
        {0x00, 0x06, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3E},
        {0x00, 0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C},
        {0x00, 0x1C, 0x36, 0x30, 0x30, 0x7C, 0x30, 0x30},
        {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x3C},
        {0x00, 0x60, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66},
        {0x00, 0x00, 0x18, 0x00, 0x18, 0x18, 0x18, 0x3C},
        {0x00, 0x0C, 0x00, 0x0C, 0x0C, 0x6C, 0x6C, 0x38},
        {0x00, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66},
        {0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18},
        {0x00, 0x00, 0x00, 0x63, 0x77, 0x7F, 0x6B, 0x6B},
        {0x00, 0x00, 0x00, 0x7C, 0x7E, 0x66, 0x66, 0x66},
        {0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C},
        {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60},
        {0x00, 0x00, 0x3C, 0x6C, 0x6C, 0x3C, 0x0D, 0x0F},
        {0x00, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x60, 0x60},
        {0x00, 0x00, 0x00, 0x3E, 0x40, 0x3C, 0x02, 0x7C},
        {0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18},
        {0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E},
        {0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x3C, 0x18},
        {0x00, 0x00, 0x00, 0x63, 0x6B, 0x6B, 0x6B, 0x3E},
        {0x00, 0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66},
        {0x00, 0x00, 0x00, 0x66, 0x66, 0x3E, 0x06, 0x3C},
        {0x00, 0x00, 0x00, 0x3C, 0x0C, 0x18, 0x30, 0x3C},
        {0x00, 0x0E, 0x18, 0x18, 0x30, 0x18, 0x18, 0x0E},
        {0x00, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18},
        {0x00, 0x70, 0x18, 0x18, 0x0C, 0x18, 0x18, 0x70},
        {0x00, 0x00, 0x00, 0x3A, 0x6C, 0x00, 0x00, 0x00},
        {0x00, 0x08, 0x1C, 0x36, 0x63, 0x41, 0x41, 0x7F}
};

Screen printScreen = BOTTOM_SCREEN;
u32 printPos = FB_BOT_HEIGHT;

u32 gfxGetWidth(Screen screen) {
    return screen == TOP_SCREEN ? FB_TOP_WIDTH : FB_BOT_WIDTH;
}

u32 gfxGetHeight(Screen screen) {
    return screen == TOP_SCREEN ? FB_TOP_HEIGHT : FB_BOT_HEIGHT;
}

void gfxClearScreen(Screen screen, u8 color) {
    if(screen == TOP_SCREEN) {
        memset((void*) FB_TOP_LEFT1, color, FB_TOP_SIZE);
        memset((void*) FB_TOP_LEFT2, color, FB_TOP_SIZE);
        memset((void*) FB_TOP_RIGHT1, color, FB_TOP_SIZE);
        memset((void*) FB_TOP_RIGHT2, color, FB_TOP_SIZE);
    } else {
        memset((void *) FB_BOT_1, color, FB_BOT_SIZE);
        memset((void *) FB_BOT_2, color, FB_BOT_SIZE);
    }

    if(screen == printScreen) {
        printPos = 0;
    }
}

void gfxClearScreens(u8 color) {
    gfxClearScreen(TOP_SCREEN, color);
    gfxClearScreen(BOTTOM_SCREEN, color);

    printScreen = TOP_SCREEN;
    printPos = 0;
}

void gfxDrawChar(Screen screen, char c, int x, int y) {
    u8* dst1 = (u8*) (screen == TOP_SCREEN ? FB_TOP_LEFT1 : FB_BOT_1);
    u8* dst2 = (u8*) (screen == TOP_SCREEN ? FB_TOP_LEFT2 : FB_BOT_2);
    u32 dstWidth = gfxGetWidth(screen);
    u32 dstHeight = gfxGetHeight(screen);

    unsigned char* data = asciiData[(int) c];
    for(int cy = 0; cy < 8; cy++) {
        unsigned char l = data[cy];
        for(int cx = 0; cx < 8; cx++) {
            if(((0b10000000 >> cx) & l) && cx > 0 && cy > 0 && cx < dstWidth && cy < dstHeight) {
                u32 index = (u32) (((dstHeight - (y + cy) - 1) + (x + cx) * dstHeight) * 3);
                dst1[index + 0] = dst2[index + 0] = 255;
                dst1[index + 1] = dst2[index + 1] = 255;
                dst1[index + 2] = dst2[index + 2] = 255;
            }
        }
    }
}

void gfxDrawString(Screen screen, const char* str, int x, int y) {
    int cx = x;
    int cy = y;
    const char* pos = str;
    while(*pos) {
        char c = *pos;
        if(c == '\n') {
            cx = x;
            cy += 8;
            continue;
        }

        gfxDrawChar(screen, c, cx, cy);
        cx += 8;
        pos++;
    }
}

void gfxPrintString(const char* str) {
    if(printPos > gfxGetHeight(printScreen) - 12) {
        if(printScreen == TOP_SCREEN) {
            gfxClearScreen(BOTTOM_SCREEN, 0);
            printScreen = BOTTOM_SCREEN;
        } else {
            gfxClearScreens(0);
            printScreen = TOP_SCREEN;
        }

        printPos = 0;
    }

    gfxDrawString(printScreen, str, 0, printPos);
    printPos += 12;
}